name: Deploy Next.js Staging to EC2

on:
  push:
    branches:
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4️⃣ Create build-time env file (NEXT_PUBLIC_ only)
      - name: Create env file for build
        run: |
          echo "${{ secrets.STAGING_ENV_FILE }}" > .env.production

      # 5️⃣ Build Next.js app (BUILD HAPPENS HERE)
      - name: Build Next.js app
        run: npm run build


      # 7️⃣ Archive build output
      - name: Archive build
        run: |
          tar --exclude='./public/uploads' \
              --exclude='.git' \
              -czf next-app.tar.gz \
              package.json package-lock.json node_modules .next public

      # 8️⃣ Copy build to EC2
      - name: Copy build to EC2
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: root
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: next-app.tar.gz
          target: /var/www/staging

      # 9️⃣ Deploy & restart with PM2 (NO BUILD ON SERVER)
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}
          username: root
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/staging
            rm -rf .next node_modules public
            tar -xzf next-app.tar.gz
            rm next-app.tar.gz
            pm2 describe mscinemas-staging > /dev/null
            if [ $? -eq 0 ]; then
                PORT=3001 pm2 reload mscinemas-staging
            else
                PORT=3001 pm2 start npm --name "mscinemas-staging" -- start
            fi

            # Save PM2 list
            pm2 save
